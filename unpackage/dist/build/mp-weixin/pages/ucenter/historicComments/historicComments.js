"use strict";const e=require("../../../common/vendor.js"),o=require("../../../uni_modules/uni-id-pages/common/store.js"),t=e.Zs.database(),n={data:()=>({showDialog:!1,isLoading:!0,loadMore:{contentdown:"",contentrefresh:"",contentnomore:""},Myans:[]}),onLoad(){this.getMyAns()},onPullDownRefresh(){this.refreshData()},onReachBottom(){this.$refs.udb.loadMore()},methods:{formatDate(e){const o=new Date(e);return`${o.getFullYear()}-${(o.getMonth()+1).toString().padStart(2,"0")}-${o.getDate().toString().padStart(2,"0")} ${o.getHours().toString().padStart(2,"0")}:${o.getMinutes().toString().padStart(2,"0")}:${o.getSeconds().toString().padStart(2,"0")}`},showDialog(e){this.showDialog=!0},cancelDialog(){this.showDialog=!1},getMyAns(){e.index.showLoading({title:"加载中...",mask:!0}),console.log("开始加载");let n=t.collection("community_ans").orderBy("created_at","desc");n=n.where({user_id:o.store.userInfo._id}),console.log(o.store.userInfo._id),n.get().then((async e=>{if(e.result.data&&Array.isArray(e.result.data)){const o=await Promise.all(e.result.data.map((e=>this.getpostinfo(e.post_id).then((o=>({...e,...o}))))));this.Myans=o}else this.Myans=[];this.isLoading=!1})).catch((o=>{console.error("获取帖子数据失败:",o),e.index.showToast({title:"加载帖子数据失败",icon:"none"}),this.isLoading=!1})).finally((()=>{e.index.hideLoading()}))},getpostinfo:async e=>t.collection("community_post").where({_id:e}).field({title:!0,likes_count:!0,ans_count:!0}).get().then((e=>{if(e.result.data&&e.result.data.length>0){const o=e.result.data[0];return{title:o.title,likes_count:o.likes_count,ans_count:o.ans_count}}return{title:"-文章已被删除-",likes_count:0}})).catch((e=>(console.error("获取帖子信息失败:",e),{title:"错误",likes_count:0}))),handleItemClick(o){console.log(o),e.index.navigateTo({url:"/pages/community/detail?id="+o.post_id+"&title="+o.title})},showOptions(o){e.index.showActionSheet({itemList:["删除","修改"],success:function(t){if(console.log("用户选择了选项："+(t.tapIndex+1)),t.tapIndex+1==1){console.log("用户选择了删除");const t=e.Zs.database();t.collection("community_ans").doc(o._id).remove().then((o=>{e.index.showToast({title:"删除成功",icon:"success"}),console.log("删除成功",o),e.index.redirectTo({url:"/pages/ucenter/historicComments/historicComments"})})).catch((o=>{console.error("删除失败",o),e.index.showToast({title:"删除失败",icon:"none"})})),o.ans_count-=1;t.collection("community_post").doc(o.post_id).update({ans_count:o.ans_count}).then((e=>{console.log("修改成功",e)})).catch((o=>{console.error("修改失败",o),e.index.showToast({title:"修改失败",icon:"none"})}))}else 1==t.tapIndex&&(console.log("用户选择了修改"),console.log(`/pages/community/modify_reply?replyId=${o._id}&post_id=${o.post_id}`),e.index.navigateTo({url:`/pages/community/modify_reply?replyId=${o._id}&post_id=${o.post_id}`}))},fail:function(e){console.log("操作菜单调用失败")},complete:function(){console.log("操作菜单调用结束")}})}}};if(!Array){(e.resolveComponent("uni-list-item")+e.resolveComponent("uni-list")+e.resolveComponent("uni-load-state")+e.resolveComponent("unicloud-db"))()}Math||((()=>"../../../uni_modules/uni-list/components/uni-list-item/uni-list-item.js")+(()=>"../../../uni_modules/uni-list/components/uni-list/uni-list.js")+(()=>"../../../components/uni-load-state/uni-load-state.js")+(()=>"../../../node-modules/@dcloudio/uni-components/lib/unicloud-db/unicloud-db.js"))();const s=e._export_sfc(n,[["render",function(o,t,n,s,i,a){return e.e({a:e.w((({data:o,pagination:t,loading:n,hasMore:s,error:l},c,r)=>e.e(i.Myans&&0!==i.Myans.length?{}:{a:"396c66ae-2-"+r+",396c66ae-1-"+r},{b:e.f(i.Myans,((o,t,n)=>({a:e.t(o.content.length>10?o.content.slice(0,10)+"...":o.content),b:e.t(o.title),c:e.t(a.formatDate(o.created_at)),d:t,e:e.o((e=>a.handleItemClick(o)),t),f:e.o((e=>this.showOptions(o)),t),g:"396c66ae-3-"+r+"-"+n+",396c66ae-1-"+r}))),c:"396c66ae-1-"+r+",396c66ae-0",d:"396c66ae-4-"+r+",396c66ae-0",e:e.p({state:{Myans:i.Myans,pagination:t,hasMore:s,loading:n,error:l}}),f:r,g:c})),{name:"d",path:"a",vueId:"396c66ae-0"}),b:!i.Myans||0===i.Myans.length,c:e.p({clickable:!0}),d:e.o(o.refreshData),e:e.sr("udb","396c66ae-0"),f:e.o((e=>0==i.isLoading)),g:e.o((e=>0==i.isLoading)),h:e.p({collection:"opendb-news-articles","page-size":10}),i:a.showDialog},a.showDialog?{j:e.o(((...e)=>a.cancelDialog&&a.cancelDialog(...e))),k:e.o((e=>o.deleteItem(o.index))),l:e.o((e=>o.modifyItem(o.index)))}:{})}]]);wx.createPage(s);
