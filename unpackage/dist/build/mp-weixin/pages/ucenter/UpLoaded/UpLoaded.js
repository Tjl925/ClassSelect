"use strict";const e=require("../../../common/vendor.js"),t=require("../../../uni_modules/uni-id-pages/common/store.js"),o=require("../../../common/assets.js"),a=e.Zs.database(),i={data:()=>({pageSize:10,iconnection:[],Mycourse:[],Mymaterials:[],Mypost:[],courseInfowithRtings:[],tabs:["已发布的课程","已发布的资料","已发布帖子"],currentTab:0,currentUserId:t.store.userInfo._id||"",isLoading:!0,loadMore:{contentdown:"",contentrefresh:"",contentnomore:""}}),onReachBottom(){console.log(this.Mycourse),this.Mycourse.length>this.pageSize?(console.log("当前课程数量："+this.Mycourse.length),this.pageSize+=5):e.index.showToast({title:"已加载全部记录",icon:"none"})},methods:{formatDate(e){const t=new Date(e);return`${t.getFullYear()}-${(t.getMonth()+1).toString().padStart(2,"0")}-${t.getDate().toString().padStart(2,"0")} ${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}:${t.getSeconds().toString().padStart(2,"0")}`},getMyCourse(){e.index.showLoading({title:"加载中...",mask:!0});let t=a.collection("course-info").orderBy("created_at","desc");t=t.where({creator_id:this.currentUserId}),t.get().then((async e=>{if(e.result.data&&Array.isArray(e.result.data)){const t=await Promise.all(e.result.data.map((e=>({...e}))));this.Mycourse=t}else this.Mycourse=[]})).catch((t=>{console.error("获取课程数据失败:",t),e.index.showToast({title:"加载课程数据失败",icon:"none"})})).finally((()=>{e.index.hideLoading()}))},getMyMaterials(){e.index.showLoading({title:"加载中...",mask:!0});let t=a.collection("materials").orderBy("created_at","desc");t=t.where({creator_id:this.currentUserId}),t.get().then((async e=>{if(e.result.data&&Array.isArray(e.result.data)){const t=await Promise.all(e.result.data.map((e=>this.getMaterialsRating(e._id).then((t=>({...e,averageRating:t}))))));this.Mymaterials=t}else this.Mymaterials=[]})).catch((t=>{console.error("获取资料数据失败:",t),e.index.showToast({title:"加载资料数据失败",icon:"none"})})).finally((()=>{e.index.hideLoading()}))},getMyPost(){let e=a.collection("community_post");e=e.where({user_id:t.store.userInfo._id}),e.get().then((async e=>{if(e.result.data&&Array.isArray(e.result.data)){const t=await Promise.all(e.result.data.map((e=>this.getNickNameinfo(e.user_id).then((t=>({...e,...t}))))));this.Mypost=t}else this.Mypost=[]})).catch((e=>{console.error("获取帖子数据失败:",e)}))},async getNickNameinfo(t){return console.log("当前的用户id"+t),a.collection("uni-id-users").where({_id:t}).field({nickname:!0,avatar:!0}).get().then((e=>{if(e.result.data&&e.result.data.length>0){const t=e.result.data[0];return{nickname:t.nickname,avatar:t.avatar}}return{nickname:"无昵称",avatar:""}})).catch((t=>{console.error("获取用户昵称失败:",t),e.index.showToast({title:"加载用户昵称失败",icon:"none"}),this.isLoading=!1}))},getMaterialsRating:async e=>a.collection("material_ratings").where({material_id:e}).get().then((e=>{if(e.result.data&&e.result.data.length>0){const t=e.result.data.map((e=>e.rating));return t.reduce(((e,t)=>e+t),0)/t.length}return"待评分"})).catch((e=>(console.error("获取资料评分失败:",e),0))),getCourseRating:async e=>a.collection("course_ratings").where({course_id:e}).get().then((e=>{if(e.result.data&&e.result.data.length>0){const t=e.result.data.map((e=>e.rating));return t.reduce(((e,t)=>e+t),0)/t.length}return"待评分"})).catch((e=>(console.error("获取课程评分失败:",e),0))),async onLoad(){await this.getMyCourse(),console.log("课程信息",this.Mycourse),console.log("课程评分信息",this.courseInfowithRtings),await this.getMyMaterials(),console.log("资料信息",this.Mymaterials),console.log("资料评分信息",this.Mymaterials),this.getMyPost(),console.log("帖子信息",this.Mypost)},switchTab(e){this.currentTab=e},onError(e){console.error("Error loading data:",e),this.isLoading=!0},showOptions(t,o){e.index.showActionSheet({itemList:["修改"],success:function(a){if(console.log("用户当前页面编号："+o),a.tapIndex+1==1){console.log("用户选择了删除");let a="";0===o?(console.log(t),a="/pages/course/modify_course?_id="+t):1===o?(console.log(t),a="/pages/material/modify_material?_id="+t):2===o&&(a="/pages/community/modify_community?postId="+t),e.index.navigateTo({url:a})}},fail:function(e){console.log("操作菜单调用失败")},complete:function(){console.log("操作菜单调用结束")}})},PosthandleItemClick(t){let o="";0===this.currentTab?o="/pages/course/detail?_id="+t._id+"&title="+t.course_name+"&averageRating="+t.averageRating:1===this.currentTab?o="/pages/material/detail?id="+t._id+"&title="+t.material_name+"&averageRating="+t.averageRating:2===this.currentTab&&(o="/pages/list/detail?id="+t._id+"&title="+t.title),e.index.navigateTo({url:o})}},mounted(){this.onLoad()}};if(!Array){(e.resolveComponent("uni-list-item")+e.resolveComponent("uni-list")+e.resolveComponent("uni-load-state")+e.resolveComponent("unicloud-db")+e.resolveComponent("uni-load-more"))()}Math||((()=>"../../../uni_modules/uni-list/components/uni-list-item/uni-list-item.js")+(()=>"../../../uni_modules/uni-list/components/uni-list/uni-list.js")+(()=>"../../../components/uni-load-state/uni-load-state.js")+(()=>"../../../node-modules/@dcloudio/uni-components/lib/unicloud-db/unicloud-db.js")+(()=>"../../../uni_modules/uni-load-more/components/uni-load-more/uni-load-more.js"))();const r=e._export_sfc(i,[["render",function(t,a,i,r,n,s){return e.e({a:e.f(n.tabs,((t,o,a)=>({a:e.t(t),b:t,c:n.currentTab===o?1:"",d:e.o((e=>s.switchTab(o)),t)}))),b:0===n.currentTab&&n.currentUserId},0===n.currentTab&&n.currentUserId?{c:e.w((({data:t,pagination:o,loading:a,hasMore:i,error:r},c,l)=>({a:e.f(n.Mycourse.slice(0,n.pageSize),((t,o,a)=>({a:e.t(t.course_name),b:e.t(t.teacher_name),c:e.t(t.average_rating||"待评分"),d:o,e:e.o((e=>s.PosthandleItemClick(t)),o),f:e.o((e=>s.showOptions(t._id,n.currentTab)),o),g:"599c5f49-2-"+l+"-"+a+",599c5f49-1-"+l}))),b:"599c5f49-1-"+l+",599c5f49-0",c:"599c5f49-3-"+l+",599c5f49-0",d:e.p({state:{Mycourse:n.Mycourse,pagination:o,hasMore:i,loading:a,error:r}}),e:l,f:c})),{name:"d",path:"c",vueId:"599c5f49-0"}),d:o._imports_0,e:e.p({clickable:!0}),f:e.sr("udbCourses","599c5f49-0"),g:e.o(s.onLoad),h:e.o(s.onError),i:e.p({collection:"course_ratings,course-info",field:"course_id,course_name, teacher_name,rating","page-size":5})}:{},{j:1===n.currentTab&&n.currentUserId},1===n.currentTab&&n.currentUserId?{k:e.w((({data:t,pagination:o,loading:a,hasMore:i,error:r},c,l)=>({a:e.f(n.Mymaterials,((t,o,a)=>({a:e.t(t.material_name),b:e.t(t.averageRating),c:o,d:e.o((e=>s.PosthandleItemClick(t)),o),e:e.o((e=>s.showOptions(t._id,n.currentTab)),o),f:"599c5f49-6-"+l+"-"+a+",599c5f49-5-"+l}))),b:"599c5f49-5-"+l+",599c5f49-4",c:"599c5f49-7-"+l+",599c5f49-4",d:e.p({state:{Mymaterials:n.Mymaterials,pagination:o,hasMore:i,loading:a,error:r}}),e:l,f:c})),{name:"d",path:"k",vueId:"599c5f49-4"}),l:e.p({clickable:!0}),m:e.sr("udbMaterials","599c5f49-4"),n:e.o(s.onLoad),o:e.o(s.onError),p:e.p({collection:"materials",field:"material_name,creator_id","page-size":10})}:{},{q:2===n.currentTab&&n.currentUserId},2===n.currentTab&&n.currentUserId?{r:e.w((({data:o,loading:a,error:i,options:r},c,l)=>e.e({a:e.f(n.Mypost,((o,a,i)=>e.e({a:o.imgs&&o.imgs[0]&&o.imgs[0].path},o.imgs&&o.imgs[0]&&o.imgs[0].path?{b:o.imgs[0].path}:{},{c:e.t(o.title),d:e.t(o.content),e:e.t(o.nickname),f:e.t(o.ans_count),g:e.o((e=>t.goToDetail(o._id)),o._id),h:o.liked?"/static/community/like_active.png":"/static/community/like.png",i:e.t(o.likes_count),j:e.o((e=>t.ChangeLike(o)),o._id),k:e.t(s.formatDate(o.created_at)),l:o._id,m:e.o((e=>s.showOptions(o._id,n.currentTab)),o._id),n:"599c5f49-10-"+l+"-"+i+",599c5f49-9-"+l,o:e.p({direction:"column",to:"/pages/community/detail?id="+o._id+"&title="+o.title})}))),b:"599c5f49-9-"+l+",599c5f49-8",c:a||"noMore"===r.status},a||"noMore"===r.status?{d:"599c5f49-11-"+l+",599c5f49-8",e:e.p({status:r.status})}:{},{f:l,g:c})),{name:"d",path:"r",vueId:"599c5f49-8"}),s:o._imports_1,t:e.sr("udb","599c5f49-8"),v:e.o(t.load),w:e.p({options:t.formData,collection:t.collection,field:t.field,where:t.whereCondition})}:{})}]]);wx.createPage(r);
