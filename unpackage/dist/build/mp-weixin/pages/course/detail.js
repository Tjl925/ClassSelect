"use strict";const e=require("../../common/vendor.js"),t=require("../../uni_modules/uni-id-pages/common/store.js"),o=require("../../common/assets.js");e.Zs.importObject("uni-id-co");const s=e.Zs.database(),n={data:()=>({isAdmin:!1,isCourseCreator:!1,hasComment:!1,course_name:"",course_location:"",college:"",teacher_name:"",credit:"",rate_count:0,comments:[],isCommentsLoading:!0,rating:0,currentRating:0,id:"",averageRating:0,starRating:[]}),computed:{userInfo:()=>t.store.userInfo,displayRating(){return 0===this.averageRating?"暂无评分":this.averageRating.toFixed(1)}},onLoad(e){this.checkUserRole(),this.checkCreator(),this.id=e._id,this.fetchInitialRating(),this.loadRating(),this.fetchcourseDetails(),this.fetchComments()},onShow(){this.fetchcourseDetails()},methods:{toCreate(){e.index.navigateTo({url:"/pages/course/create_course/create_course"})},$log(...e){console.log("args",...e,this.id)},async checkUserRole(){try{const e=s.collection("uni-id-users"),t=await e.doc(this.userInfo._id).field("user_role").get();t.result.data.length>0&&"admin"===t.result.data[0].user_role&&(this.isAdmin=!0)}catch(e){console.error("检查用户角色失败:",e)}},async checkCreator(){try{const e=s.collection("course-info"),t=await e.doc(this.id).get();t.result.data.length>0&&t.result.data[0].creator_id===this.userInfo._id&&(this.isCourseCreator=!0)}catch(e){console.error("检查课程信息创建者失败:",e)}},goToModifyPage(){e.index.navigateTo({url:`/pages/course/modify_course?_id=${this.id}`})},goToReportPage(t){e.index.navigateTo({url:`/uni_modules/uni-feedback/pages/opendb-report/opendb-report?reported_id=${t}&type=课程信息`})},async fetchInitialRating(){try{const t=e.Zs.database(),o=await t.collection("course-info").doc(this.id).get();o.result.data.length>0?(this.averageRating=o.result.data[0].average_rating||0,this.generateStarRating(this.averageRating)):console.error("课程不存在")}catch(t){console.error("获取初始评分失败",t)}},loadRating(){const e=s.collection("course_ratings"),t=this.userInfo._id;console.log("当前用户ID:",t);const o=this.id;e.where({course_id:o,user_id:t}).get().then((e=>{if(e.result.data&&e.result.data.length>0){const t=e.result.data[0].rating;this.currentRating=t,console.log("已评分:",t)}else this.currentRating=0,console.log("用户尚未评分")})).catch((e=>{console.error("查询评分记录失败:",e)}))},generateStarRating(e){const t=Math.floor(e),o=e-t>=.5?1:0;this.starRating=Array(t).fill("full").concat(o?["half"]:[])},fetchcourseDetails(){s.collection("course-info").doc(this.id).get().then((t=>{if(t.result.data&&t.result.data.length>0){const e=t.result.data[0];this.course_name=e.course_name||"未记录",this.course_location=e.course_location||"未记录",this.college=e.college||"未记录",this.teacher_name=e.teacher_name||"未记录",this.credit=e.credit||"未记录",this.course_number=e.course_number||"未记录"}else e.index.showToast({title:"课程不存在",icon:"none"})})).catch((t=>{console.error("获取详情失败:",t),e.index.showToast({title:"加载失败",icon:"none"})}))},async fetchComments(){const t=s.collection("course_comments").orderBy("created_at","desc"),o=s.collection("uni-id-users");this.isCommentsLoading=!0;try{const e=(await t.where({course_id:this.id}).get()).result.data||[],s=e.map((async e=>{var t;try{return(null==(t=(await o.doc(e.user_id).field("avatar_file, nickname").get()).result.data)?void 0:t[0])||{}}catch(s){return console.error(`加载用户 ${e.user_id} 信息失败:`,s),{}}})),n=await Promise.all(s);this.comments=e.map(((e,t)=>{var o;const s=n[t];return{avatar:(null==(o=s.avatar_file)?void 0:o.url)||"/static/default-avatar.png",nickname:s.nickname||"匿名用户",_id:e._id,user_id:e.user_id,comment_text:e.comment_text,created_at:e.created_at}}))}catch(n){console.error("加载评论失败:",n),e.index.showToast({title:"评论加载失败",icon:"none"})}finally{this.isCommentsLoading=!1}},handleLongPress(t){e.index.showActionSheet({itemList:["删除"],success:async o=>{if(0===o.tapIndex)try{t.user_id===this.userInfo._id||this.isAdmin?(await this.deleteComment(t._id),e.index.showToast({title:"删除成功",icon:"success"})):e.index.showToast({title:"没有权限删除",icon:"none"})}catch(s){e.index.showToast({title:"操作失败",icon:"none"})}},fail:()=>{console.log("取消操作")}})},async deleteComment(e){try{await s.collection("course_comments").doc(e).remove(),this.comments=this.comments.filter((t=>t._id!==e))}catch(t){throw console.error("删除评论失败:",t),t}},rate(t){const o=s.collection("course_ratings"),n=this.userInfo._id,i=this.id;console.log("当前用户ID",n),n?o.where({course_id:i,user_id:n}).get().then((s=>{s.result.data&&s.result.data.length>0?(e.index.showToast({title:"您已评过分，请前往个人中心修改",icon:"none"}),console.log("评分记录已存在:",s.result.data[0])):e.index.showModal({title:"确认评分",content:`您确定要给 ${t} 星评分吗？`,success:s=>{if(s.confirm){const s=(new Date).toISOString();o.add({course_id:i,user_id:n,rating:t,created_at:s}).then((()=>{e.index.showToast({title:`评分成功: ${t} 星`,icon:"success"}),console.log("评分记录已添加:",{course_id:i,user_id:n,rating:t,created_at:s}),this.currentRating=t,this.updateAverageRating(i)})).catch((t=>{console.error("评分失败:",t),e.index.showToast({title:"评分失败，请稍后再试",icon:"none"})}))}else console.log("用户取消评分")}})})).catch((t=>{console.error("查询评分记录失败:",t),e.index.showToast({title:"评分查询失败，请稍后再试",icon:"none"})})):e.index.showModal({title:"未登录",content:"您未登录，是否前往登录？",success:t=>{t.confirm?e.index.navigateTo({url:"/pages/login/login"}):console.log("用户取消跳转到登录页面")}})},async updateAverageRating(t){try{const e=s.collection("course_ratings"),o=s.collection("course-info"),n=await e.where({course_id:t}).get();if(n.result.data&&n.result.data.length>0){const e=n.result.data.map((e=>e.rating)),s=e.reduce(((e,t)=>e+t),0)/e.length;await o.doc(t).update({average_rating:s}),console.log("平均评分已更新:",s),this.averageRating=s,this.generateStarRating(s)}else console.warn("未找到评分记录，无法计算平均评分")}catch(o){console.error("更新平均评分失败:",o),e.index.showToast({title:"更新评分失败，请稍后再试",icon:"none"})}},downloadcourse(){const t=s.collection("courses"),o=this.id;t.doc(o).get().then((t=>{if(t.result.data&&t.result.data.length>0){const o=t.result.data[0].download_link;o?e.index.showModal({title:"下载资料",content:`资料下载链接：${o}`,confirmText:"复制链接",success:t=>{t.confirm?e.index.setClipboardData({data:o,success:()=>{e.index.showToast({title:"下载链接已复制",icon:"success"})}}):console.log("用户取消复制链接")}}):e.index.showToast({title:"未找到下载链接",icon:"none"})}else e.index.showToast({title:"课程不存在",icon:"none"})})).catch((t=>{console.error("获取下载链接失败:",t),e.index.showToast({title:"获取下载链接失败",icon:"none"})}))},postComment(){const t=this.userInfo._id;t?e.index.showModal({title:"发表评论",content:"",editable:!0,placeholderText:"请输入评论内容（100字以内）",success:o=>{if(o.confirm){const n=o.content.trim();if(0===n.length)return void e.index.showToast({title:"评论内容不能为空",icon:"none"});if(n.length>100)return void e.index.showToast({title:"评论内容超过100字",icon:"none"});const i=this.id,a=(new Date).toISOString();console.log("当前用户ID",t),console.log("当前时间",a),s.collection("course_comments").add({user_id:t,course_id:i,comment_text:n,created_at:a}).then((t=>{var o;console.log("评论发布成功:",t);const s={avatar:(null==(o=this.userInfo.avatar_file)?void 0:o.url)||"/static/default-avatar.png",nickname:this.userInfo.nickname||"匿名用户",comment_text:n,created_at:a};this.comments.unshift(s),this.fetchComments(),e.index.showToast({title:"评论发布成功",icon:"success"})})).catch((t=>{console.error("评论发布失败:",t),e.index.showToast({title:"评论发布失败",icon:"none"})}))}else console.log("用户取消评论")}}):e.index.showModal({title:"未登录",content:"您未登录，是否前往登录？",success:t=>{t.confirm?e.index.navigateTo({url:"/pages/login/login"}):console.log("用户取消跳转到登录页面")}})},formatDate(e){const t=new Date(e);return`${t.getFullYear()}-${(t.getMonth()+1).toString().padStart(2,"0")}-${t.getDate().toString().padStart(2,"0")} ${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`}}};const i=e._export_sfc(n,[["render",function(t,s,n,i,a,r){return e.e({a:a.isAdmin||a.isCourseCreator},a.isAdmin||a.isCourseCreator?{b:o._imports_0$4,c:e.o(((...e)=>r.goToModifyPage&&r.goToModifyPage(...e)))}:{d:o._imports_1$4,e:e.o((e=>r.goToReportPage(a.id)))},{f:e.t(a.course_name),g:e.t(a.teacher_name),h:e.t(a.credit),i:e.t(a.rate_count),j:e.t(a.college),k:e.t(a.course_location),l:e.t(t.course_number),m:e.t(r.displayRating),n:e.f(a.starRating,((e,t,o)=>({a:t,b:"full"===e?"/static/full-star.png":"/static/half-star.png"}))),o:a.isCommentsLoading},(a.isCommentsLoading,{}),{p:e.f(a.comments,((t,o,s)=>({a:t.avatar,b:e.t(t.nickname),c:e.t(r.formatDate(t.created_at)),d:e.t(t.comment_text),e:e.o((e=>r.handleLongPress(t)),o),f:o}))),q:e.f(5,((t,o,s)=>({a:t,b:t<=a.currentRating?1:"",c:e.o((e=>r.rate(t)),t)}))),r:e.o(((...e)=>r.toCreate&&r.toCreate(...e))),s:e.o(((...e)=>r.postComment&&r.postComment(...e)))})}]]);wx.createPage(i);
