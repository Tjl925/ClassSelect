"use strict";const t=require("../../common/vendor.js"),e=require("../../uni_modules/uni-id-pages/common/store.js");require("../../common/html-parser.js");const o=require("../../common/assets.js"),s=t.Zs.database(),i={data:()=>({overlayVisible:!1,isAddingAns:!1,isLiking:!1,id:"",title:"",field:"_id,user_id,content,created_at,likes_count,ans_count,title,avatar_file",formData:{status:"loading"},tipShow:!1,post:{liked:!1},post_avatar_file:"",answers:[],newAns:{content:""}}),computed:{where(){return console.log(this.id),`_id =="${this.id}"`},checkRole(){return!!(e.store.userInfo.user_role&&"admin"==e.store.userInfo.user_role||e.store.userInfo._id==this.post.user_id)}},onLoad(t){t.id&&(this.id=t.id),t.title&&(this.title=t.title)},onReady(){this.id?this.getPosts(this.id).then((()=>{this.getAns(this.id).then((()=>{this.getAnsIMG().then((()=>{this.getLikes()}))}))})):t.index.showToast({icon:"none",title:"出错了，新闻ID为空"})},methods:{checkItemRole:t=>"admin"===e.store.userInfo.user_role||e.store.userInfo._id===t.user_id,editReply(e){console.log(`/pages/community/modify_reply?replyId=${e}&post_id=${this.post._id}`),t.index.navigateTo({url:`/pages/community/modify_reply?replyId=${e}&post_id=${this.post._id}`})},reportReply(e){t.index.navigateTo({url:`/uni_modules/uni-feedback/pages/opendb-report/opendb-report?reported_id=${e}&type=评论`})},editPost(e){t.index.navigateTo({url:`/pages/community/modify_community?postId=${e}`})},reportPost(e){t.index.navigateTo({url:`/uni_modules/uni-feedback/pages/opendb-report/opendb-report?reported_id=${e}&type=帖子`})},goToAddPage(){e.store.hasLogin?(this.isAddingAns=!0,this.overlayVisible=!0):t.index.showToast({title:"请登陆后再回复",icon:"none"})},addAns(){""!==this.newAns.content.trim()?(this.post.ans_count+=1,t.index.showLoading({mask:!0,title:"发布中"}),s.collection("community_ans").add({user_id:e.store.userInfo._id,content:this.newAns.content,post_id:this.post._id,created_at:(new Date).toISOString()}).then((()=>{s.collection("community_post").doc(this.post._id).update({ans_count:this.post.ans_count}).then((()=>{t.index.hideLoading(),this.cancelAddAns(),this.getPosts(this.id).then((()=>{this.getAns(this.id).then((()=>{this.getAnsIMG().then((()=>{this.getLikes()}))}))})),console.log("回复成功"),getApp().globalData.community_status=0})).catch((t=>{console.error("更新帖子回复计数失败:",t)}))})).catch((t=>{console.error("添加回复记录失败:",t)}))):t.index.showToast({title:"内容不能为空",icon:"none"})},load(t,e){e&&(this.formData.status="noMore"),t&&(this.post=t,""===this.title&&t.title&&(this.title=t.title))},formatDate(t){const e=new Date(t);return`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")} ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}`},cancelAddAns(){this.newAns.content="",this.isAddingAns=!1,this.overlayVisible=!1},getPosts(e){return new Promise(((o,i)=>{t.index.showLoading({mask:!0}),s.collection("community_post").where({_id:e}).get().then((e=>{if(t.index.hideLoading(),e.result.data&&e.result.data.length>0){const t=e.result.data[0];this.getNickName(t.user_id).then((e=>{t.nickname=e,t.liked=!1,this.post=t,this.getImg(t.user_id).then((t=>{this.post_avatar_file=t,o(this.post)})).catch((t=>{console.error("获取头像失败:",t),this.post_avatar_file="",o(this.post)}))}))}else this.post={liked:!1},this.post_avatar_file="",o(this.post)})).catch((e=>{console.error("获取帖子数据失败:",e),t.index.showToast({title:"加载帖子数据失败",icon:"none"}),this.post={},this.post_avatar_file="",o(this.post)}))}))},getNickName:t=>s.collection("uni-id-users").where({_id:t}).field("nickname").get().then((e=>{if(e.result.data&&e.result.data.length>0){const o=e.result.data[0].nickname;return console.log(`ID: ${t}`),console.log(`名称: ${o}`),o}return console.log(`ID: ${t}`),console.log("没有数据"),"未知用户"})).catch((t=>(console.error("获取失败:",t),"未知用户"))),getAns(e){return new Promise(((o,i)=>{this.answers=[],t.index.showLoading({mask:!0}),s.collection("community_ans").where({post_id:e}).orderBy("created_at","asc").get().then((t=>{if(t.result.data&&Array.isArray(t.result.data)){const e=t.result.data.map((t=>this.getNickName(t.user_id).then((e=>({...t,nickname:e})))));Promise.all(e).then((t=>{this.answers=t,o()}))}else this.answers=[],o()})).catch((e=>{console.error("获取用户名称失败:",e),t.index.showToast({title:"加载用户名称失败",icon:"none"}),o()})).finally((()=>{t.index.hideLoading()}))}))},async getAnsIMG(){try{const t=this.answers.map((t=>this.getImg(t.user_id).then((e=>({...t,avatarUrl:e.avatarUrl||""}))))),e=await Promise.all(t);this.answers=e}catch(t){console.error("获取头像数据失败:",t)}},getImg:t=>s.collection("uni-id-users").where({_id:t}).field("avatar_file").get().then((t=>{if(t.result.data&&t.result.data.length>0&&t.result.data[0]){return{avatarUrl:t.result.data[0].avatar_file.url}}return{avatarUrl:""}})).catch((t=>(console.error("获取头像失败:",t),{avatarUrl:""}))),async getLikes(){if(e.store.hasLogin)try{await this.getlikes(this.post._id).then((t=>{this.post.liked=t}))}catch(t){console.error("获取点赞数据失败:",t)}else this.post.liked=!1},getlikes:t=>new Promise(((o,i)=>{const n=e.store.userInfo._id;s.collection("community_like").where({user_id:n,post_id:t}).field("post_id").limit(1).get().then((t=>{t.result.data&&t.result.data.length>0?o(!0):o(!1)})).catch((t=>{console.error("获取点赞失败:",t),o(!1)}))})),ChangeLike(t){this.isLiking||(this.isLiking=!0,s.collection("community_like").where({post_id:t._id,user_id:e.store.userInfo._id}).get().then((e=>{e.result.data.length>0?this.cancelLike(t):this.addLike(t)})).catch((t=>{console.error("查询点赞状态失败:",t)})).finally((()=>{this.isLiking=!1})),getApp().globalData.community_status=0)},addLike(t){t.likes_count+=1,t.liked=!0,s.collection("community_like").add({post_id:t._id,user_id:e.store.userInfo._id,created_at:(new Date).toISOString()}).then((()=>{s.collection("community_post").doc(t._id).update({likes_count:t.likes_count}).then((()=>{console.log("点赞成功")})).catch((t=>{console.error("更新帖子点赞计数失败:",t)}))})).catch((t=>{console.error("添加点赞记录失败:",t)}))},cancelLike(t){t.likes_count-=1,t.liked=!1,s.collection("community_like").where({post_id:t._id,user_id:e.store.userInfo._id}).remove().then((()=>{s.collection("community_post").doc(t._id).update({likes_count:t.likes_count}).then((()=>{console.log("取消点赞成功")})).catch((t=>{console.error("更新帖子点赞计数失败:",t)}))})).catch((t=>{console.error("删除点赞记录失败:",t)}))}},onPullDownRefresh(){this.formData.status="more",this.$refs.udb.loadData({clear:!0},(()=>{this.tipShow=!0,clearTimeout(this.timer),this.timer=setTimeout((()=>{this.tipShow=!1}),1e3),t.index.stopPullDownRefresh()})),this.getPosts(this.id).then((()=>{this.getAns(this.id).then((()=>{this.getAnsIMG().then((()=>{this.getLikes()}))})),console.log("帖子数据加载完成")}))},onReachBottom(){this.$refs.udb.loadMore()},onShow(){this.id&&this.getPosts(this.id).then((()=>{this.getAns(this.id).then((()=>{this.getAnsIMG().then((()=>{this.getLikes()}))}))}))}};if(!Array){(t.resolveComponent("template")+t.resolveComponent("uni-load-more")+t.resolveComponent("unicloud-db"))()}Math||((()=>"../../uni_modules/uni-load-more/components/uni-load-more/uni-load-more.js")+(()=>"../../node-modules/@dcloudio/uni-components/lib/unicloud-db/unicloud-db.js"))();const n=t._export_sfc(i,[["render",function(e,s,i,n,a,r){return t.e({a:a.tipShow?1:"",b:t.w((({data:e,loading:s,error:i,options:n},d,l)=>t.e({a:!s&&e},!s&&e?t.e({b:t.t(a.title),c:a.post_avatar_file.avatarUrl},a.post_avatar_file.avatarUrl?{d:a.post_avatar_file.avatarUrl,e:t.t(a.post.nickname),f:t.t(r.formatDate(a.post.created_at))}:{},{g:e.content,h:a.post.imgs&&a.post.imgs[0]&&a.post.imgs[0].path},a.post.imgs&&a.post.imgs[0]&&a.post.imgs[0].path?{i:a.post.imgs[0].path}:{},{j:o._imports_1,k:t.o(((...t)=>r.goToAddPage&&r.goToAddPage(...t))),l:a.post},a.post?{m:a.post.liked?"/static/community/like_active.png":"/static/community/like.png",n:t.o((t=>r.ChangeLike(a.post)))}:{},{o:r.checkRole},r.checkRole?{p:o._imports_1$2,q:t.o((t=>r.editPost(a.id)))}:{r:o._imports_2,s:t.o((t=>r.reportPost(a.id)))}):{},(a.post&&Object.keys(a.post).length,{}),{t:t.f(a.answers,((e,s,i)=>t.e({a:e.avatarUrl,b:t.t(e.nickname),c:r.checkItemRole(e)},r.checkItemRole(e)?{d:o._imports_1$2,e:t.o((t=>r.editReply(e._id)),e._id)}:{f:o._imports_2,g:t.o((t=>r.reportReply(e._id)),e._id)},{h:t.t(e.content),i:t.t(r.formatDate(e.created_at)),j:e._id}))),v:s||"noMore"===n.status},s||"noMore"===n.status?{w:"2c9a43b0-1-"+l+",2c9a43b0-0",x:t.p({status:n.status})}:{},{y:l,z:d})),{name:"d",path:"b",vueId:"2c9a43b0-0"}),c:a.post&&Object.keys(a.post).length,d:t.sr("udb","2c9a43b0-0"),e:t.o(r.load),f:t.p({options:a.formData,collection:"community_post",where:r.where,field:a.field,getone:!0,manual:!0}),g:a.overlayVisible},a.overlayVisible?{h:t.o(((...t)=>r.cancelAddAns&&r.cancelAddAns(...t)))}:{},{i:a.isAddingAns},a.isAddingAns?{j:a.newAns.content,k:t.o((t=>a.newAns.content=t.detail.value)),l:t.o(((...t)=>r.addAns&&r.addAns(...t))),m:t.o(((...t)=>r.cancelAddAns&&r.cancelAddAns(...t)))}:{})}]]);wx.createPage(n);
