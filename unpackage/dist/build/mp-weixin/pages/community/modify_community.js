"use strict";const t=require("../../common/vendor.js"),e=require("../../uni_modules/uni-id-pages/common/store.js"),o=t.Zs.database(),i={data:()=>({post:{content:"",imgs:[],title:"",user_id:"",likes_count:0,ans_count:0,article_status:1},CurrentAvatar_file:{extname:"",name:"",url:""},width:"200px",height:"200px",border:!1}),methods:{deletePost(){t.index.showModal({title:"确认删除",content:"确定要删除这个贴子吗？",success:async e=>{if(e.confirm)try{t.index.showLoading({title:"删除中...",mask:!0});const e=await o.collection("community_post").doc(this.post._id).remove();if(console.log(e),getApp().globalData.community_status=0,1!==e.result.deleted)throw new Error("删除失败");t.index.showToast({title:"删除成功",icon:"success"}),setTimeout((()=>{t.index.navigateBack({delta:2})}),2e3)}catch(i){console.error("删除贴子失败:",i),t.index.showToast({title:i.message||"删除失败",icon:"none"})}finally{t.index.hideLoading()}else e.cancel&&console.log("用户取消删除")}})},async fetchPostDetails(){try{const t=await o.collection("community_post").doc(this.post._id).get();if(console.log(t),!(t.result.data&&Array.isArray(t.result.data)&&t.result.data.length>0))throw new Error("未找到贴子信息");{const e=t.result.data[0];this.post.title=e.title,this.post.content=e.content,e.imgs&&e.imgs[0]&&e.imgs[0].path&&(this.post.imgs=e.imgs)}}catch(e){console.error("获取贴子信息失败:",e),t.index.showToast({title:"获取贴子信息失败",icon:"none"})}},async Mybindchooseavatar(o){let i=o.detail.avatarUrl,s={extname:i.split(".")[i.split(".").length-1],name:"",url:""},n=e.store.userInfo._id+""+Date.now();s.name=n;try{t.index.showLoading({title:"上传中",mask:!0});let{fileID:e}=await t.Zs.uploadFile({filePath:i,cloudPath:"/cloudstorage/community_image/"+n,fileType:"image",cloudPathAsRealPath:!0,onUploadProgress:function(t){console.log(t);Math.round(100*t.loaded/t.total)}});s.url=e,this.post.avatar_file.extname=s.extname,this.post.avatar_file.name=s.name,this.post.avatar_file.url=s.url,console.log(e),t.index.hideLoading()}catch(a){console.error(a)}},async submitPostInfo(){if(""!==this.post.content.trim())if(""!==this.post.title.trim()){console.log(this.post.content);try{t.index.showLoading({title:"提交中...",mask:!0}),console.log(this.post._id);const e=await o.collection("community_post").doc(this.post._id).update({title:this.post.title,content:this.post.content,imgs:this.post.imgs});if(console.log(e),!e.result.updated)throw new Error("修改失败");t.index.showToast({title:"修改成功",icon:"success"}),setTimeout((()=>{t.index.navigateBack()}),2e3)}catch(e){console.error("提交贴子信息失败:",e),t.index.showToast({title:e.message||"提交失败",icon:"none"})}finally{t.index.hideLoading()}}else t.index.showToast({title:"标题不能为空",icon:"none"});else t.index.showToast({title:"内容不能为空",icon:"none"})},navBack(){t.index.navigateBack()}},onLoad(e){this.post._id=e.postId,t.index.setNavigationBarTitle({title:"修改贴子信息"}),this.fetchPostDetails()}};if(!Array){(t.resolveComponent("uni-file-picker")+t.resolveComponent("uni-forms-item")+t.resolveComponent("template"))()}Math||((()=>"../../uni_modules/uni-file-picker/components/uni-file-picker/uni-file-picker.js")+(()=>"../../uni_modules/uni-forms/components/uni-forms-item/uni-forms-item.js"))();const s=t._export_sfc(i,[["render",function(e,o,i,s,n,a){return{a:n.post.title,b:t.o((t=>n.post.title=t.detail.value)),c:n.post.content,d:t.o((t=>n.post.content=t.detail.value)),e:t.o((t=>n.post.imgs=t)),f:t.p({"file-mediatype":"image",limit:1,"return-type":"array",modelValue:n.post.imgs}),g:t.p({name:"imgs",label:"图片列表"}),h:t.o((t=>a.navBack())),i:t.o((t=>a.submitPostInfo())),j:t.o((t=>a.deletePost())),k:t.o(((...t)=>a.submitPostInfo&&a.submitPostInfo(...t)))}}],["__scopeId","data-v-d32728cc"]]);wx.createPage(s);
