"use strict";const e=require("../../../common/vendor.js"),t=require("../../../uni_modules/uni-id-pages/common/store.js"),a=require("../../../common/assets.js"),o=e.Zs.database(),i={data:()=>({pageSize:10,iconnection:[],Mycourse:[],Mymaterials:[],Mypost:[],courseInfowithRtings:[],tabs:["已发布的课程","已发布的资料","已发布帖子"],currentTab:0,currentUserId:t.store.userInfo._id||"",isLoading:!0,loadMore:{contentdown:"",contentrefresh:"",contentnomore:""}}),onReachBottom(){console.log(this.Mycourse),this.Mycourse.length>this.pageSize?(console.log("当前课程数量："+this.Mycourse.length),this.pageSize+=5):e.index.showToast({title:"已加载全部记录",icon:"none"})},methods:{formatDate(e){const t=new Date(e);return`${t.getFullYear()}-${(t.getMonth()+1).toString().padStart(2,"0")}-${t.getDate().toString().padStart(2,"0")} ${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}:${t.getSeconds().toString().padStart(2,"0")}`},getMyCourse(){e.index.showLoading({title:"加载中...",mask:!0}),o.collection("course-info").orderBy("created_at","desc").get().then((async e=>{if(e.result.data&&Array.isArray(e.result.data)){const t=await Promise.all(e.result.data.map((e=>({...e}))));this.Mycourse=t}else this.Mycourse=[]})).catch((t=>{console.error("获取课程数据失败:",t),e.index.showToast({title:"加载课程数据失败",icon:"none"})})).finally((()=>{e.index.hideLoading()}))},getMyMaterials(){e.index.showLoading({title:"加载中...",mask:!0}),o.collection("materials").orderBy("created_at","desc").get().then((async e=>{if(e.result.data&&Array.isArray(e.result.data)){const t=await Promise.all(e.result.data.map((e=>this.getMaterialsRating(e._id).then((t=>({...e,averageRating:t}))))));this.Mymaterials=t}else this.Mymaterials=[]})).catch((t=>{console.error("获取资料数据失败:",t),e.index.showToast({title:"加载资料数据失败",icon:"none"})})).finally((()=>{e.index.hideLoading()}))},getMyPost(){o.collection("community_post").get().then((async e=>{if(e.result.data&&Array.isArray(e.result.data)){const t=await Promise.all(e.result.data.map((e=>this.getNickNameinfo(e.user_id).then((t=>({...e,...t}))))));this.Mypost=t}else this.Mypost=[]})).catch((e=>{console.error("获取帖子数据失败:",e)}))},async getNickNameinfo(t){return console.log("当前的用户id"+t),o.collection("uni-id-users").where({_id:t}).field({nickname:!0,avatar:!0}).get().then((e=>{if(e.result.data&&e.result.data.length>0){const t=e.result.data[0];return{nickname:t.nickname,avatar:t.avatar}}return{nickname:"无昵称",avatar:""}})).catch((t=>{console.error("获取用户昵称失败:",t),e.index.showToast({title:"加载用户昵称失败",icon:"none"}),this.isLoading=!1}))},getMaterialsRating:async e=>o.collection("material_ratings").where({material_id:e}).get().then((e=>{if(e.result.data&&e.result.data.length>0){const t=e.result.data.map((e=>e.rating));return t.reduce(((e,t)=>e+t),0)/t.length}return"待评分"})).catch((e=>(console.error("获取资料评分失败:",e),0))),getCourseRating:async e=>o.collection("course_ratings").where({course_id:e}).get().then((e=>{if(e.result.data&&e.result.data.length>0){const t=e.result.data.map((e=>e.rating));return t.reduce(((e,t)=>e+t),0)/t.length}return"待评分"})).catch((e=>(console.error("获取课程评分失败:",e),0))),async onLoad(){await this.getMyCourse(),console.log("课程信息",this.Mycourse),console.log("课程评分信息",this.courseInfowithRtings),await this.getMyMaterials(),console.log("资料信息",this.Mymaterials),console.log("资料评分信息",this.Mymaterials),this.getMyPost(),console.log("帖子信息",this.Mypost)},switchTab(e){this.currentTab=e},onError(e){console.error("Error loading data:",e),this.isLoading=!0},showOptions(t,a){e.index.showActionSheet({itemList:["修改"],success:function(o){if(console.log("用户当前页面编号："+a),o.tapIndex+1==1){console.log("用户选择了删除");let o="";0===a?(console.log(t),o="/pages/course/modify_course?_id="+t):1===a?o="/pages/material/modify_material?_id="+t:2===a&&(o="/pages/community/modify_community?_id="+t),e.index.navigateTo({url:o})}},fail:function(e){console.log("操作菜单调用失败")},complete:function(){console.log("操作菜单调用结束")}})},PosthandleItemClick(t){let a="";0===this.currentTab?a="/pages/course/detail?_id="+t._id+"&title="+t.course_name+"&averageRating="+t.averageRating:1===this.currentTab?a="/pages/material/detail?id="+t._id+"&title="+t.material_name+"&averageRating="+t.averageRating:2===this.currentTab&&(a="/pages/list/detail?id="+t._id+"&title="+t.title),e.index.navigateTo({url:a})}},mounted(){this.onLoad()}};if(!Array){(e.resolveComponent("uni-list-item")+e.resolveComponent("uni-list")+e.resolveComponent("uni-load-state")+e.resolveComponent("unicloud-db")+e.resolveComponent("uni-load-more"))()}Math||((()=>"../../../uni_modules/uni-list/components/uni-list-item/uni-list-item.js")+(()=>"../../../uni_modules/uni-list/components/uni-list/uni-list.js")+(()=>"../../../components/uni-load-state/uni-load-state.js")+(()=>"../../../node-modules/@dcloudio/uni-components/lib/unicloud-db/unicloud-db.js")+(()=>"../../../uni_modules/uni-load-more/components/uni-load-more/uni-load-more.js"))();const n=e._export_sfc(i,[["render",function(t,o,i,n,r,s){return e.e({a:e.f(r.tabs,((t,a,o)=>({a:e.t(t),b:t,c:r.currentTab===a?1:"",d:e.o((e=>s.switchTab(a)),t)}))),b:0===r.currentTab&&r.currentUserId},0===r.currentTab&&r.currentUserId?{c:e.w((({data:t,pagination:a,loading:o,hasMore:i,error:n},l,c)=>({a:e.f(r.Mycourse.slice(0,r.pageSize),((t,a,o)=>({a:e.t(t.course_name),b:e.t(t.teacher_name),c:e.t(t.average_rating||"待评分"),d:a,e:e.o((e=>s.PosthandleItemClick(t)),a),f:e.o((e=>s.showOptions(t._id,r.currentTab)),a),g:"68d6b0f7-2-"+c+"-"+o+",68d6b0f7-1-"+c}))),b:"68d6b0f7-1-"+c+",68d6b0f7-0",c:"68d6b0f7-3-"+c+",68d6b0f7-0",d:e.p({state:{Mycourse:r.Mycourse,pagination:a,hasMore:i,loading:o,error:n}}),e:c,f:l})),{name:"d",path:"c",vueId:"68d6b0f7-0"}),d:a._imports_0,e:e.p({clickable:!0}),f:e.sr("udbCourses","68d6b0f7-0"),g:e.o(s.onLoad),h:e.o(s.onError),i:e.p({collection:"course_ratings,course-info",field:"course_id,course_name, teacher_name,rating","page-size":5})}:{},{j:1===r.currentTab&&r.currentUserId},1===r.currentTab&&r.currentUserId?{k:e.w((({data:t,pagination:a,loading:o,hasMore:i,error:n},l,c)=>({a:e.f(r.Mymaterials,((t,a,o)=>({a:e.t(t.material_name),b:e.t(t.averageRating),c:a,d:e.o((e=>s.PosthandleItemClick(t)),a),e:e.o((e=>s.showOptions(t._id,r.currentTab)),a),f:"68d6b0f7-6-"+c+"-"+o+",68d6b0f7-5-"+c}))),b:"68d6b0f7-5-"+c+",68d6b0f7-4",c:"68d6b0f7-7-"+c+",68d6b0f7-4",d:e.p({state:{Mymaterials:r.Mymaterials,pagination:a,hasMore:i,loading:o,error:n}}),e:c,f:l})),{name:"d",path:"k",vueId:"68d6b0f7-4"}),l:e.p({clickable:!0}),m:e.sr("udbMaterials","68d6b0f7-4"),n:e.o(s.onLoad),o:e.o(s.onError),p:e.p({collection:"materials",field:"material_name,creator_id","page-size":10})}:{},{q:2===r.currentTab&&r.currentUserId},2===r.currentTab&&r.currentUserId?{r:e.w((({data:a,loading:o,error:i,options:n},l,c)=>e.e({a:e.f(r.Mypost,((a,o,i)=>e.e({a:a.imgs&&a.imgs[0]&&a.imgs[0].path},a.imgs&&a.imgs[0]&&a.imgs[0].path?{b:a.imgs[0].path}:{},{c:e.t(a.title),d:e.t(a.content),e:e.t(a.nickname),f:e.t(a.ans_count),g:e.o((e=>t.goToDetail(a._id)),a._id),h:a.liked?"/static/community/like_active.png":"/static/community/like.png",i:e.t(a.likes_count),j:e.o((e=>t.ChangeLike(a)),a._id),k:e.t(s.formatDate(a.created_at)),l:a._id,m:"68d6b0f7-10-"+c+"-"+i+",68d6b0f7-9-"+c,n:e.p({direction:"column",to:"/pages/community/detail?id="+a._id+"&title="+a.title})}))),b:"68d6b0f7-9-"+c+",68d6b0f7-8",c:o||"noMore"===n.status},o||"noMore"===n.status?{d:"68d6b0f7-11-"+c+",68d6b0f7-8",e:e.p({status:n.status})}:{},{f:c,g:l})),{name:"d",path:"r",vueId:"68d6b0f7-8"}),s:a._imports_1,t:e.sr("udb","68d6b0f7-8"),v:e.o(t.load),w:e.p({options:t.formData,collection:t.collection,field:t.field,where:t.whereCondition})}:{})}]]);wx.createPage(n);
