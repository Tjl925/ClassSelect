"use strict";const t=require("../../../common/vendor.js"),e=require("../../../uni_modules/uni-id-pages/common/store.js"),o=require("../../../common/assets.js"),s=t.Zs.database(),i=()=>"../../../uni_modules/uni-id-pages/components/uni-id-pages-avatar/uni-id-pages-avatar.js",n={computed:{inputPlaceholder:e=>"en"==t.index.getStorageSync("CURRENT_LANG")?"Please enter the search content":"请输入搜索内容",whereCondition(){let t='"article_status" == 1';return this.keyword?`${t} && (/${this.keyword}/.test(title) || /${this.keyword}/.test(content))`:t},userInfo:()=>e.store.userInfo},data:()=>({pageSize:6,postData:{content:"",imgs:[],title:"",user_id:"",likes_count:0,ans_count:0,article_status:1},formOptions:{},test_url:"https://mp-55788fb7-2392-4142-8486-dfaba6fb925c.cdn.bspapp.com/cloudstorage/user.png",where:'"article_status" == 1',keyword:"",width:"200px",height:"200px",border:!1,collection:"community_post",field:"_id,user_id,content,created_at,likes_count,ans_count,title",formData:{status:"loading"},tipShow:!1,posts:[],newPost:{title:"",content:"",article_status:1},CurrentAvatar_file:{extname:"",name:"",url:""},isAddingPost:!1,overlayVisible:!1,isLiking:!1}),watch:{keyword(t){this.updateWhereCondition(),this.posts=[],console.log("根据关键字重新加载"),this.getPosts().then((()=>{this.getLikes()}))}},methods:{cancelAddPost(){this.isAddingPost=!1,this.overlayVisible=!1,this.postData.content="",this.postData.imgs=[],this.postData.title=""},submit(){t.index.showLoading({mask:!0}),this.submitForm(this.postData),t.index.hideLoading(),console.log("提交"),this.getPosts().then((()=>{this.getLikes()}))},submitForm(o){this.postData.user_id=e.store.userInfo._id,this.postData.created_at=(new Date).toISOString(),s.collection("community_post").add(o).then((e=>{t.index.showToast({icon:"none",title:"提交成功"}),setTimeout((()=>this.cancelAddPost()),500)})).catch((e=>{t.index.showModal({content:e.message||"请求服务失败",showCancel:!1})})).finally((()=>{t.index.hideLoading()}))},load(t,e){e&&(this.formData.status="noMore")},updateWhereCondition(){let t='"article_status" == 1';this.where=this.keyword?`${t} && (/${this.keyword}/.test(title) || /${this.keyword}/.test(content))`:t},searchClick(e){t.index.hideKeyboard(),this.posts=[],t.index.navigateTo({url:"/pages/community/search/search",animationType:"fade-in"})},async getLikes(){if(e.store.hasLogin)try{const t=this.posts.map((t=>this.getlikes(t._id).then((e=>{t.liked=e}))));await Promise.all(t)}catch(t){console.error("获取点赞数据失败:",t)}else this.posts.forEach((t=>{t.liked=!1}))},getlikes:t=>new Promise(((o,i)=>{const n=e.store.userInfo._id;s.collection("community_like").where({user_id:n,post_id:t}).field("post_id").get().then((e=>{if(e.result.data&&e.result.data.length>0){const s=e.result.data.some((e=>e.post_id===t));o(s)}else o(!1)})).catch((t=>{console.error("获取点赞失败:",t),o(!1)}))})),getPosts(){return new Promise(((e,o)=>{this.posts=[],t.index.showLoading({mask:!0}),s.collection("community_post").orderBy("likes_count","desc").limit(10).get().then((t=>{if(t.result.data&&Array.isArray(t.result.data)){const o=t.result.data.map((t=>this.getPostName(t.user_id).then((e=>({...t,nickname:e})))));Promise.all(o).then((t=>{this.posts=t,e()}))}else this.posts=[],e()})).catch((o=>{console.error("获取用户名称失败:",o),t.index.showToast({title:"加载用户名称失败",icon:"none"}),e()})).finally((()=>{t.index.hideLoading()}))}))},getPostName:t=>new Promise(((e,o)=>{s.collection("uni-id-users").where({_id:t}).field("nickname").get().then((o=>{if(o.result.data&&o.result.data.length>0){const s=o.result.data[0].nickname;console.log(`ID: ${t}`),console.log(`名称: ${s}`),e(s)}else console.log(`ID: ${t}`),console.log("没有数据"),e("未知用户")})).catch((t=>{console.error("获取失败:",t),e("未知用户")}))})),ChangeLike(t){this.isLiking||(this.isLiking=!0,s.collection("community_like").where({post_id:t._id,user_id:e.store.userInfo._id}).get().then((e=>{e.result.data.length>0?this.cancelLike(t):this.addLike(t)})).catch((t=>{console.error("查询点赞状态失败:",t)})).finally((()=>{this.isLiking=!1})))},addLike(t){t.likes_count+=1,t.liked=!0,s.collection("community_like").add({post_id:t._id,user_id:e.store.userInfo._id,created_at:(new Date).toISOString()}).then((()=>{s.collection("community_post").doc(t._id).update({likes_count:t.likes_count}).then((()=>{console.log("点赞成功")})).catch((t=>{console.error("更新帖子点赞计数失败:",t)}))})).catch((t=>{console.error("添加点赞记录失败:",t)}))},cancelLike(t){t.likes_count-=1,t.liked=!1,s.collection("community_like").where({post_id:t._id,user_id:e.store.userInfo._id}).remove().then((()=>{s.collection("community_post").doc(t._id).update({likes_count:t.likes_count}).then((()=>{console.log("取消点赞成功")})).catch((t=>{console.error("更新帖子点赞计数失败:",t)}))})).catch((t=>{console.error("删除点赞记录失败:",t)}))},formatDate(t){const e=new Date(t);return`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")} ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}`},goToAddPage(){e.store.hasLogin?(this.isAddingPost=!0,this.overlayVisible=!0):t.index.showToast({title:"请登陆后再发贴",icon:"none"})},addPost(){""!==this.newPost.title.trim()&&""!==this.newPost.content.trim()?(t.index.showLoading({mask:!0,title:"发布中"}),s.collection("community_post").add({user_id:e.store.userInfo._id,content:this.newPost.content,created_at:(new Date).toISOString(),likes_count:0,ans_count:0,title:this.newPost.title,avatar_file:this.CurrentAvatar_file,article_status:1}).then((e=>{t.index.hideLoading(),this.cancelAddPost(),console.log("提交1"),this.getPosts().then((()=>{this.getLikes()}))})).catch((e=>{t.index.hideLoading(),t.index.showToast({title:"发布失败",icon:"none"}),console.error("创建帖子失败:",e)}))):t.index.showToast({title:"标题和内容不能为空",icon:"none"})},async Mybindchooseavatar(o){let s=o.detail.avatarUrl,i={extname:s.split(".")[s.split(".").length-1],name:"",url:""},n=e.store.userInfo._id+""+Date.now();i.name=n;try{t.index.showLoading({title:"上传中",mask:!0});let{fileID:e}=await t.Zs.uploadFile({filePath:s,cloudPath:"/cloudstorage/community_image/"+n,fileType:"image",cloudPathAsRealPath:!0,onUploadProgress:function(t){console.log(t)}});i.url=e,this.CurrentAvatar_file.extname=i.extname,this.CurrentAvatar_file.name=i.name,this.CurrentAvatar_file.url=i.url,console.log(e),t.index.hideLoading()}catch(a){console.error(a)}},uploadAvatarImg(){i.methods.uploadAvatarImg()}},onShow(){this.keyword=getApp().globalData.searchText,console.log(this.keyword),console.log(this.where),getApp().globalData.searchText="",console.log(111),console.log(getApp().globalData.community_status),getApp().globalData.community_status?1==getApp().globalData.community_status&&console.log(getApp().globalData.community_status):0==getApp().globalData.community_status&&(console.log("show"),this.getPosts().then((()=>{this.getLikes()})))},onPullDownRefresh(){this.formData.status="more",this.$refs.udb.loadData({clear:!0},(()=>{this.tipShow=!0,clearTimeout(this.timer),this.timer=setTimeout((()=>{this.tipShow=!1}),1e3),t.index.stopPullDownRefresh()})),console.log("下滑刷新"),this.getPosts().then((()=>{this.getLikes()}))},onReachBottom(){this.$refs.udb.loadMore()},onLoad(t){console.log("加载"),this.getPosts().then((()=>{this.getLikes()}))},onReachBottom(){console.log(this.posts),this.posts.length>this.pageSize?(console.log("当前课程数量："+this.posts.length),this.pageSize+=6):t.index.showToast({title:"已查看点赞数前10帖子",icon:"none"})}};if(!Array){(t.resolveComponent("uni-list-item")+t.resolveComponent("uni-list")+t.resolveComponent("uni-load-more")+t.resolveComponent("unicloud-db"))()}Math||((()=>"../../../uni_modules/uni-list/components/uni-list-item/uni-list-item.js")+(()=>"../../../uni_modules/uni-list/components/uni-list/uni-list.js")+(()=>"../../../uni_modules/uni-load-more/components/uni-load-more/uni-load-more.js")+(()=>"../../../node-modules/@dcloudio/uni-components/lib/unicloud-db/unicloud-db.js"))();const a=t._export_sfc(n,[["render",function(e,s,i,n,a,l){return{a:t.w((({data:o,loading:s,error:i,options:n},r,c)=>t.e({a:t.f(a.posts.slice(0,a.pageSize),((o,s,i)=>t.e({a:o.imgs&&o.imgs[0]&&o.imgs[0].path},o.imgs&&o.imgs[0]&&o.imgs[0].path?{b:o.imgs[0].path}:{},{c:t.t(o.title),d:t.t(o.content),e:t.t(o.nickname),f:t.t(o.ans_count),g:t.o((t=>e.goToDetail(o._id)),o._id),h:o.liked?"/static/community/like_active.png":"/static/community/like.png",i:t.t(o.likes_count),j:t.o((t=>l.ChangeLike(o)),o._id),k:t.t(l.formatDate(o.created_at)),l:o._id,m:"0f858faa-2-"+c+"-"+i+",0f858faa-1-"+c,n:t.p({direction:"column",to:"/pages/community/detail?id="+o._id+"&title="+o.title})}))),b:"0f858faa-1-"+c+",0f858faa-0",c:s||"noMore"===n.status},s||"noMore"===n.status?{d:"0f858faa-3-"+c+",0f858faa-0",e:t.p({status:n.status})}:{},{f:c,g:r})),{name:"d",path:"a",vueId:"0f858faa-0"}),b:o._imports_1,c:t.sr("udb","0f858faa-0"),d:t.o(l.load),e:t.p({options:a.formData,collection:a.collection,field:a.field,where:l.whereCondition})}}]]);wx.createPage(a);
