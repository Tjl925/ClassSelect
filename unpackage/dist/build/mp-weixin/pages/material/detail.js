"use strict";const t=require("../../common/vendor.js"),e=require("../../uni_modules/uni-id-pages/common/store.js"),a=require("../../common/assets.js");t.Zs.importObject("uni-id-co");const i=t.Zs.database(),o={data:()=>({isAdmin:!1,isMaterialCreator:!1,materialImage:"",title:"",category:"",courseName:"",comments:[],isCommentsLoading:!0,rating:0,currentRating:0,id:"",averageRating:0,starRating:[]}),computed:{userInfo:()=>e.store.userInfo,displayRating(){return 0===this.averageRating?"暂无评分":this.averageRating.toFixed(1)}},onLoad(t){this.checkUserRole(),this.checkCreator(),this.id=t.id,this.title=t.title?decodeURIComponent(t.title):"未命名",this.fetchInitialRating(),this.loadRating(),this.fetchMaterialDetails(),this.fetchComments()},onShow(){this.fetchMaterialDetails()},methods:{$log(...t){console.log("args",...t,this.id)},async checkUserRole(){try{const t=i.collection("uni-id-users"),e=await t.doc(this.userInfo._id).field("user_role").get();e.result.data.length>0&&"admin"===e.result.data[0].user_role&&(this.isAdmin=!0)}catch(t){console.error("检查用户角色失败:",t)}},async checkCreator(){try{const t=i.collection("materials"),e=await t.doc(this.id).get();e.result.data.length>0&&e.result.data[0].creator_id===this.userInfo._id&&(this.isMaterialCreator=!0)}catch(t){console.error("检查资料创建者失败:",t)}},goToModifyPage(){t.index.navigateTo({url:`/pages/material/modify_material?_id=${this.id}`})},goToReportPage(e){t.index.navigateTo({url:`/uni_modules/uni-feedback/pages/opendb-report/opendb-report?reported_id=${e}&type=资料`})},async fetchInitialRating(){try{const e=t.Zs.database(),a=await e.collection("materials").doc(this.id).get();a.result.data.length>0?(this.averageRating=a.result.data[0].average_rating||0,this.generateStarRating(this.averageRating)):console.error("资料不存在")}catch(e){console.error("获取初始评分失败",e)}},loadRating(){const t=i.collection("material_ratings"),e=this.userInfo._id;console.log("当前用户ID:",e);const a=this.id;t.where({material_id:a,user_id:e}).get().then((t=>{if(t.result.data&&t.result.data.length>0){const e=t.result.data[0].rating;this.currentRating=e,console.log("已评分:",e)}else this.currentRating=0,console.log("用户尚未评分")})).catch((t=>{console.error("查询评分记录失败:",t)}))},generateStarRating(t){const e=Math.floor(t),a=t-e>=.5?1:0;this.starRating=Array(e).fill("full").concat(a?["half"]:[])},fetchMaterialDetails(){i.collection("materials").doc(this.id).get().then((e=>{if(e.result.data&&e.result.data.length>0){const t=e.result.data[0];this.materialImage=t.material_image&&t.material_image.length>0?t.material_image[0].url:"/static/default-image.png",this.title=t.material_name||"未命名",this.category=t.category||"未定义类别",this.courseName=t.course_name||"未定义课程"}else t.index.showToast({title:"资料不存在",icon:"none"}),this.materialImage="/static/default-image.png"})).catch((e=>{console.error("获取资料详情失败:",e),t.index.showToast({title:"资料加载失败",icon:"none"}),this.materialImage="/static/default-image.png"}))},async fetchComments(){const e=i.collection("material_comments").orderBy("created_at","desc"),a=i.collection("uni-id-users");this.isCommentsLoading=!0;try{const t=(await e.where({material_id:this.id}).get()).result.data||[],i=t.map((async t=>{var e;try{return(null==(e=(await a.doc(t.user_id).field("avatar_file, nickname").get()).result.data)?void 0:e[0])||{}}catch(i){return console.error(`加载用户 ${t.user_id} 信息失败:`,i),{}}})),o=await Promise.all(i);this.comments=t.map(((t,e)=>{var a;const i=o[e];return{avatar:(null==(a=i.avatar_file)?void 0:a.url)||"/static/default-avatar.png",nickname:i.nickname||"匿名用户",_id:t._id,user_id:t.user_id,comment_text:t.comment_text,created_at:t.created_at}}))}catch(o){console.error("加载评论失败:",o),t.index.showToast({title:"评论加载失败",icon:"none"})}finally{this.isCommentsLoading=!1}},handleLongPress(e){t.index.showActionSheet({itemList:["删除"],success:async a=>{if(0===a.tapIndex)try{e.user_id===this.userInfo._id||this.isAdmin?(await this.deleteComment(e._id),t.index.showToast({title:"删除成功",icon:"success"})):t.index.showToast({title:"没有权限删除",icon:"none"})}catch(i){t.index.showToast({title:"操作失败",icon:"none"})}},fail:()=>{console.log("取消操作")}})},async deleteComment(t){try{await i.collection("material_comments").doc(t).remove(),this.comments=this.comments.filter((e=>e._id!==t))}catch(e){throw console.error("删除评论失败:",e),e}},rate(e){const a=i.collection("material_ratings");i.collection("materials");const o=this.userInfo._id,n=this.id;console.log("当前用户ID",o),o?a.where({material_id:n,user_id:o}).get().then((i=>{i.result.data&&i.result.data.length>0?(t.index.showToast({title:"您已评过分，请前往个人中心修改",icon:"none"}),console.log("评分记录已存在:",i.result.data[0])):t.index.showModal({title:"确认评分",content:`您确定要给 ${e} 星评分吗？`,success:i=>{if(i.confirm){const i=(new Date).toISOString();a.add({material_id:n,user_id:o,rating:e,created_at:i}).then((()=>{t.index.showToast({title:`评分成功: ${e} 星`,icon:"success"}),console.log("评分记录已添加:",{material_id:n,user_id:o,rating:e,created_at:i}),this.currentRating=e,this.updateAverageRating(n)})).catch((e=>{console.error("评分失败:",e),t.index.showToast({title:"评分失败，请稍后再试",icon:"none"})}))}else console.log("用户取消评分")}})})).catch((e=>{console.error("查询评分记录失败:",e),t.index.showToast({title:"评分查询失败，请稍后再试",icon:"none"})})):t.index.showModal({title:"未登录",content:"您未登录，是否前往登录？",success:e=>{e.confirm?t.index.navigateTo({url:"/uni_modules/uni-id-pages/pages/login/login-withpwd"}):console.log("用户取消跳转到登录页面")}})},async updateAverageRating(e){try{const t=i.collection("material_ratings"),a=i.collection("materials"),o=await t.where({material_id:e}).get();if(o.result.data&&o.result.data.length>0){const t=o.result.data.map((t=>t.rating)),i=t.reduce(((t,e)=>t+e),0)/t.length;await a.doc(e).update({average_rating:i}),console.log("平均评分已更新:",i),this.averageRating=i,this.generateStarRating(i)}else console.warn("未找到评分记录，无法计算平均评分")}catch(a){console.error("更新平均评分失败:",a),t.index.showToast({title:"更新评分失败，请稍后再试",icon:"none"})}},downloadMaterial(){const e=i.collection("materials"),a=this.id;e.doc(a).get().then((e=>{if(e.result.data&&e.result.data.length>0){const a=e.result.data[0].download_link;a?t.index.showModal({title:"下载资料",content:`资料下载链接：${a}`,confirmText:"复制链接",success:e=>{e.confirm?t.index.setClipboardData({data:a,success:()=>{t.index.showToast({title:"下载链接已复制",icon:"success"})}}):console.log("用户取消复制链接")}}):t.index.showToast({title:"未找到下载链接",icon:"none"})}else t.index.showToast({title:"资料不存在",icon:"none"})})).catch((e=>{console.error("获取下载链接失败:",e),t.index.showToast({title:"获取下载链接失败",icon:"none"})}))},postComment(){const e=this.userInfo._id;e?t.index.showModal({title:"发表评论",content:"",editable:!0,placeholderText:"请输入评论内容（100字以内）",success:a=>{if(a.confirm){const o=a.content.trim();if(0===o.length)return void t.index.showToast({title:"评论内容不能为空",icon:"none"});if(o.length>100)return void t.index.showToast({title:"评论内容超过100字",icon:"none"});const n=this.id,s=(new Date).toISOString();console.log("当前用户ID",e),console.log("当前时间",s),i.collection("material_comments").add({user_id:e,material_id:n,comment_text:o,created_at:s}).then((e=>{var a;console.log("评论发布成功:",e);const i={avatar:(null==(a=this.userInfo.avatar_file)?void 0:a.url)||"/static/default-avatar.png",nickname:this.userInfo.nickname||"匿名用户",comment_text:o,created_at:s};this.comments.unshift(i),this.fetchComments(),t.index.showToast({title:"评论发布成功",icon:"success"})})).catch((e=>{console.error("评论发布失败:",e),t.index.showToast({title:"评论发布失败",icon:"none"})}))}else console.log("用户取消评论")}}):t.index.showModal({title:"未登录",content:"您未登录，是否前往登录？",success:e=>{e.confirm?t.index.navigateTo({url:"/uni_modules/uni-id-pages/pages/login/login-withpwd"}):console.log("用户取消跳转到登录页面")}})},formatData(t){const e=new Date(t);return`${e.getFullYear()}-${(e.getMonth()+1).toString().padStart(2,"0")}-${e.getDate().toString().padStart(2,"0")} ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}`}}};const n=t._export_sfc(o,[["render",function(e,i,o,n,s,r){return t.e({a:s.materialImage},s.materialImage?{b:s.materialImage}:{},{c:s.isAdmin||s.isMaterialCreator},s.isAdmin||s.isMaterialCreator?{d:a._imports_0$4,e:t.o(((...t)=>r.goToModifyPage&&r.goToModifyPage(...t)))}:{f:a._imports_1$4,g:t.o((t=>r.goToReportPage(s.id)))},{h:t.t(s.title),i:t.t(r.displayRating),j:t.f(s.starRating,((t,e,a)=>({a:e,b:"full"===t?"/static/full-star.png":"/static/half-star.png"}))),k:t.t(s.category),l:t.t(s.courseName),m:s.isCommentsLoading},(s.isCommentsLoading,{}),{n:t.f(s.comments,((e,a,i)=>({a:e.avatar,b:t.t(e.nickname),c:t.t(r.formatData(e.created_at)),d:t.t(e.comment_text),e:t.o((t=>r.handleLongPress(e)),a),f:a}))),o:t.f(5,((e,a,i)=>({a:e,b:e<=s.currentRating?1:"",c:t.o((t=>r.rate(e)),e)}))),p:t.o(((...t)=>r.downloadMaterial&&r.downloadMaterial(...t))),q:t.o(((...t)=>r.postComment&&r.postComment(...t)))})}]]);wx.createPage(n);
